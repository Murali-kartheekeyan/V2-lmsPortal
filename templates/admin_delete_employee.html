<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Delete Employee - LMS Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
  <style>
    :root { --primary-color:#00d9ff; --primary-dark:#00b8d4; --background:#0f172a; --sidebar:#1e293b; --card:#1e293b; --text:#f8fafc; --muted:#94a3b8; --border:#334155; --danger:#ef4444; }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Poppins',sans-serif;background:var(--background);color:var(--text)}
    .dashboard{display:flex;min-height:100vh}
    .sidebar{width:260px;background:var(--sidebar);padding:1.5rem;border-right:1px solid var(--border)}
    .sidebar a{color:var(--muted);text-decoration:none;display:flex;align-items:center;padding:.75rem 1rem;border-radius:8px;margin-bottom:.25rem}
    .sidebar a:hover{background-color:rgba(0,217,255,.1);color:#a7f3ff}
    .main{flex:1;padding:2rem}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1.5rem;max-width:900px;margin:0 auto}
    .grid{display:grid;grid-template-columns:1fr auto;gap:.75rem;align-items:center}
    .row{display:flex;gap:.75rem;align-items:center;margin:.75rem 0}
    input{background:#131c31;border:1px solid var(--border);border-radius:8px;padding:.75rem 1rem;color:var(--text)}
    button{background:var(--danger);border:none;color:#fff;padding:.8rem 1.2rem;border-radius:8px;font-weight:600;cursor:pointer}
    button.secondary{background:var(--primary-color);color:#0f172a}
    table{width:100%;border-collapse:collapse;margin-top:1rem}
    th,td{padding:.75rem 1rem;border-bottom:1px solid var(--border)}
    thead{background:#2a3a54}
    .toast{position:fixed;top:20px;right:20px;background:#fff;color:#333;padding:12px 16px;border-left:5px solid;border-radius:8px;box-shadow:0 5px 15px rgba(0,0,0,.2)}
    .toast.error{border-color:var(--danger)}
    .toast.success{border-color:#22c55e}
  </style>
  <script>
    function showToast(msg,type='success'){
      const t=document.createElement('div');
      t.className=`toast ${type}`;
      t.textContent=msg;
      document.body.appendChild(t);
      setTimeout(()=>t.remove(),4000)
    }
  </script>
</head>
<body>
  <div class="dashboard">
    <nav class="sidebar">
      <a href="{{ url_for('dashboard_admin') }}" style="text-decoration:none;color:inherit">
        <div style="display:flex;align-items:center;gap:1rem;margin-bottom:2rem">
          <i class="fas fa-brain" style="font-size:2rem;color:var(--primary-color)"></i>
          <h1 style="font-size:1.3rem;color:#fff">LMS Admin</h1>
        </div>
      </a>
      <div>
        <h3 style="font-size:0.8rem;color:var(--muted);text-transform:uppercase;margin:1rem 0 0.5rem">Management</h3>
        <a href="{{ url_for('admin.hr_agent_page') }}"><i class="fas fa-users" style="margin-right:.75rem"></i> Employees</a>
        <a href="{{ url_for('admin.courses_page') }}"><i class="fas fa-book" style="margin-right:.75rem"></i> Courses</a>
        <h3 style="font-size:0.8rem;color:var(--muted);text-transform:uppercase;margin:1rem 0 0.5rem">Other</h3>
        <a href="#" onclick="logout(event)"><i class="fas fa-sign-out-alt" style="margin-right:.75rem"></i> Logout</a>
      </div>
    </nav>
    <main class="main">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
          <h2>Delete Employee</h2>
          <a href="{{ url_for('admin.hr_agent_page') }}" style="text-decoration:none">
            <button class="secondary" style="background:var(--muted);padding:0.5rem 1rem">
              <i class="fas fa-arrow-left"></i> Back to Employees
            </button>
          </a>
        </div>
        
        <div class="row">
          <input id="searchInput" type="text" placeholder="Search by ID or Name..." style="flex:1" />
          <select id="domainFilter" style="background:#131c31;border:1px solid var(--border);border-radius:8px;padding:.75rem 1rem;color:var(--text)">
            <option value="">All Domains</option>
            <!-- Will be populated dynamically -->
          </select>
          <button class="secondary" onclick="refreshList()"><i class="fas fa-rotate"></i> Refresh</button>
        </div>
        
        <table>
          <thead><tr><th>ID</th><th>Name</th><th>Domain</th><th>Action</th></tr></thead>
          <tbody id="tbody"></tbody>
        </table>
        
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:1rem">
          <div>
            <span id="paginationInfo">Page 1 of 1</span>
          </div>
          <div>
            <button id="prevPageBtn" class="secondary" style="margin-right:0.5rem" disabled>
              <i class="fas fa-chevron-left"></i> Previous
            </button>
            <button id="nextPageBtn" class="secondary" disabled>
              Next <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>
    </main>
  </div>
  <script>
    let allEmployees = [];
    let currentPage = 1;
    const itemsPerPage = 10;

    async function refreshList(){
      const tbody=document.getElementById('tbody');
      tbody.innerHTML='<tr><td colspan="4">Loading...</td></tr>'
      try{
        const res=await fetch('/admin/list_employees',{credentials:'include'});
        const data=await res.json();
        tbody.innerHTML='';
        allEmployees = (data.success && Array.isArray(data.employees)) ? data.employees : [];
        populateDomainFilter();
        currentPage = 1;
        displayEmployees();
      }catch(e){
        tbody.innerHTML='<tr><td colspan="4">Failed to load employees.</td></tr>'
      }
    }

    function populateDomainFilter() {
      const domainFilter = document.getElementById('domainFilter');
      domainFilter.innerHTML = '<option value="">All Domains</option>';
      const domains = new Set();
      allEmployees.forEach(emp => {
        if (emp.domain) {
          domains.add(emp.domain.toLowerCase());
        }
      });
      domains.forEach(domain => {
        const option = document.createElement('option');
        option.value = domain;
        option.textContent = domain.charAt(0).toUpperCase() + domain.slice(1);
        domainFilter.appendChild(option);
      });
    }

    function filterEmployees() {
      const searchTerm = (document.getElementById('searchInput').value || '').trim().toLowerCase();
      const selectedDomain = document.getElementById('domainFilter').value;
      return allEmployees.filter(emp => {
        const matchesSearch = searchTerm === '' || 
                            (emp.NAME?.toLowerCase().includes(searchTerm)) || 
                            (emp.id?.toString().includes(searchTerm));
        const empDomain = (emp.domain || '').toLowerCase();
        const matchesDomain = selectedDomain === '' || empDomain === selectedDomain;
        return matchesSearch && matchesDomain;
      });
    }

    function displayEmployees() {
      const filteredEmployees = filterEmployees();
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const displayedEmployees = filteredEmployees.slice(startIndex, endIndex);
      renderRows(displayedEmployees);
      updatePaginationControls(filteredEmployees.length);
    }

    function renderRows(list){
      const tbody=document.getElementById('tbody');
      tbody.innerHTML='';
      if(!list || list.length===0){
        tbody.innerHTML='<tr><td colspan="4">No employees found.</td></tr>'
        return;
      }
      list.forEach(emp=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${emp.id}</td><td>${emp.NAME||'N/A'}</td><td>${emp.domain||'N/A'}</td><td><button onclick="deleteById(${emp.id})"><i class="fas fa-user-minus"></i> Delete</button></td>`;
        tbody.appendChild(tr);
      });
    }

    function updatePaginationControls(totalItems) {
      const totalPages = Math.ceil(totalItems / itemsPerPage);
      const prevBtn = document.getElementById('prevPageBtn');
      const nextBtn = document.getElementById('nextPageBtn');
      const paginationInfo = document.getElementById('paginationInfo');
      prevBtn.disabled = currentPage <= 1;
      nextBtn.disabled = currentPage >= totalPages;
      paginationInfo.textContent = totalPages > 0 ? `Page ${currentPage} of ${totalPages}` : 'No pages';
    }

    async function deleteById(id){
      if(!id){ 
        showToast('Invalid employee ID','error'); 
        return;
      }
      if(!confirm('Are you sure you want to delete this employee?')) return;
      try{
        const res=await fetch('/admin/delete_employee',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body:JSON.stringify({emp_id:id})
        });
        const data=await res.json();
        if(data.success){ 
          showToast(data.message,'success'); 
          refreshList(); 
        }
        else{ showToast(data.error||'Failed to delete','error'); }
      }catch(e){ 
        showToast('Request failed','error'); 
      }
    }

    async function logout(event) {
      event.preventDefault();
      try {
        await fetch("/logout", {method: "POST", credentials: "include"});
        window.location.href = "/";
      } catch (e) {
        showToast('Logout failed','error');
      }
    }

    document.getElementById('prevPageBtn').addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        displayEmployees();
      }
    });
    
    document.getElementById('nextPageBtn').addEventListener('click', () => {
      const filteredEmployees = filterEmployees();
      const totalPages = Math.ceil(filteredEmployees.length / itemsPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        displayEmployees();
      }
    });

    document.getElementById('searchInput').addEventListener('input', () => {
      currentPage = 1;
      displayEmployees();
    });
    
    document.getElementById('domainFilter').addEventListener('change', () => {
      currentPage = 1;
      displayEmployees();
    });

    window.addEventListener('DOMContentLoaded', refreshList);
  </script>
</body>
</html>
